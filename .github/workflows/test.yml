name: Test Suite

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  check:
    name: Django System Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Django system check
      run: |
        python manage.py check --settings=config.settings.development
    
    - name: Check for pending migrations
      run: |
        python manage.py makemigrations --check --dry-run --settings=config.settings.development

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Check Python syntax
      run: |
        python -m py_compile manage.py
        find . -type f -name "*.py" ! -path "./venv/*" ! -path "./*/migrations/*" ! -path "./*/__pycache__/*" -exec python -m py_compile {} \;

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [check, lint]
    if: always()
    steps:
    - name: Check test results
      run: |
        echo "üß™ Test Suite Summary"
        echo "===================="
        
        # Check system check job
        if [ "${{ needs.check.result }}" == "success" ]; then
          echo "‚úÖ Django System Check: PASSED"
        else
          echo "‚ùå Django System Check: FAILED"
        fi
        
        # Check lint job
        if [ "${{ needs.lint.result }}" == "success" ]; then
          echo "‚úÖ Code Quality Check: PASSED"
        else
          echo "‚ùå Code Quality Check: FAILED"
        fi
        
        # Overall status
        if [ "${{ needs.check.result }}" == "success" ] && [ "${{ needs.lint.result }}" == "success" ]; then
          echo "üéâ All checks passed!"
          exit 0
        else
          echo "üí• Some checks failed!"
          exit 1
        fi

